---
- hosts: all
  become: true
  pre_tasks:


  - name: update repo index (Ubuntu)
    tags: always
    apt:
      update_cache: yes
      cache_valid_time: 3600
    changed_when: false
    when: ansible_distribution == "Ubuntu"
  
  # - name: make sure that ansible requirements are present
  #   tags: always
  #   shell: |
  #     ansible-galaxy install -r ./playbooks/requirements.yml
  #   changed_when: false


- hosts: all
  # become: true
  roles:
    - sbaerlocher.qemu-guest-agent # https://github.com/sbaerlocher/ansible.qemu-guest-agent
    - base
    - base_apps
    # - slick_shell
    # - chezmoi


- hosts: all
  post_tasks:
    - name: Check that the reboot-required exists
      stat:
        path: /var/run/reboot-required
      register: p
    - debug:
        msg: "Reboot required"
      when: p.stat.exists == true
    - name: Reboot
      reboot:
        msg: Rebooting
      when: p.stat.exists == true

# TODO: Include the upgrade process to update all installed tools to the latest version.